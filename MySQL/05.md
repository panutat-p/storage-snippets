# Pessimistic Locking

```sql
START TRANSACTION;
SELECT id, name, price FROM fruit WHERE name = 'apple' FOR UPDATE;
DO SLEEP(10);
COMMIT;
```

```sql
UPDATE fruit SET price = 100 WHERE name = 'banana';
```

* In certain circumstances, the SELECT ... FOR UPDATE statement can lock more than just the rows it retrieves
* MySQL acquires exclusive next-key locks for the rows it retrieves
* The next-key lock is a combination of a record lock on the index record and a gap lock on the gap before the index record
* This means that not only the selected row is locked, but also the gap before this row in the index order

> In this case, if the 'apple' row comes before the 'banana' row in the index order,
> the `SELECT ... FOR UPDATE` statement on 'apple' will also lock the gap before 'banana',
> preventing any new rows from being inserted in this gap or any modification to the 'banana' row until the lock is released.
