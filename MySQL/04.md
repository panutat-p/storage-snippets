# Event Sourcing

* `log_xxx` table provides a complete history of events
* Referential integrity is not needed
* Data consistency is not needed

## Schemaless log

```sql
CREATE TABLE fruits (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(255),
    price DECIMAL(20,2),
    tags JSON,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

```sql
CREATE TABLE log_fruits (
    id INT AUTO_INCREMENT PRIMARY KEY,
    fruit_id INT NOT NULL,
    activity VARCHAR(255) NOT NULL,
    record JSON NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL
);
```

## MySQL triggers

```sql
CREATE TABLE fruits (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(255),
    price DECIMAL(20,2),
    tags JSON,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

```sql
CREATE TABLE log_fruits (
    id INT AUTO_INCREMENT PRIMARY KEY,
    action VARCHAR(255),
    data JSON,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

```sql
DELIMITER //
CREATE TRIGGER fruits_after_insert AFTER INSERT ON fruits
FOR EACH ROW
BEGIN
    INSERT INTO log_fruits(action, data)
    VALUES ('INSERT', JSON_OBJECT('id', NEW.id, 'name', NEW.name, 'price', NEW.price, 'tags', NEW.tags, 'updated_at', NEW.updated_at, 'created_at', NEW.created_at));
END;//
DELIMITER ;

DELIMITER //
CREATE TRIGGER fruits_after_update AFTER UPDATE ON fruits
FOR EACH ROW
BEGIN
    INSERT INTO log_fruits(action, data)
    VALUES ('UPDATE', JSON_OBJECT('id', NEW.id, 'name', NEW.name, 'price', NEW.price, 'tags', NEW.tags, 'updated_at', NEW.updated_at, 'created_at', NEW.created_at));
END;//
DELIMITER ;

DELIMITER //
CREATE TRIGGER fruits_after_delete AFTER DELETE ON fruits
FOR EACH ROW
BEGIN
    INSERT INTO log_fruits(action, data)
    VALUES ('DELETE', JSON_OBJECT());
END;//
DELIMITER ;
```
